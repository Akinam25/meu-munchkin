<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Munchkin Ultimate - 3 a 6 Jogadores</title>
    <style>
        :root { --parchment: #f4e4bc; --border: #8b4513; --wood: #5d4037; --munchkin: #c0392b; --gold: #d4af37; --special: #9b59b6; --big: #2ecc71; --active: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: #333; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Tela Inicial */
        #setup-screen { position: fixed; inset: 0; background: radial-gradient(#3e5871, #2c3e50); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .setup-box { background: var(--parchment); padding: 40px; border-radius: 20px; border: 8px solid var(--munchkin); color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #leaderboard { background: #1a252f; padding: 10px; display: flex; justify-content: center; gap: 8px; border-bottom: 3px solid var(--wood); color: white; overflow-x: auto; }
        .player-status-card { background: #34495e; padding: 6px 10px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; text-align: center; min-width: 110px; flex-shrink: 0; }
        .player-status-card.active-turn { border-color: var(--munchkin); background: #4e1a1a; box-shadow: 0 0 10px var(--munchkin); }
        .p-name { display: block; font-weight: bold; font-size: 0.8rem; border-bottom: 1px solid #555; overflow: hidden; text-overflow: ellipsis; }
        .p-stats { font-size: 0.7rem; color: var(--gold); }

        #table-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(#3e5871, #2c3e50); color: white; padding: 10px; }
        .decks { display: flex; gap: 20px; margin-bottom: 10px; }
        .deck { width: 90px; height: 130px; border: 3px solid white; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .deck-door { background: #8b4513; }
        .deck-loot { background: #5d4037; border-color: var(--gold); color: var(--gold); }
        
        #log-container { background: rgba(0,0,0,0.5); width: 95%; max-width: 800px; height: 60px; overflow-y: auto; padding: 8px; border-radius: 5px; font-size: 0.75rem; color: #eee; border-left: 4px solid var(--munchkin); }

        #battle-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .battle-card { background: var(--parchment); color: #333; padding: 25px; border-radius: 15px; border: 6px solid var(--munchkin); text-align: center; min-width: 400px; }

        #player-area { background: var(--parchment); padding: 10px; border-top: 5px solid var(--border); }
        .playmat { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; max-width: 1100px; margin: 0 auto; }
        .slot { border: 2px solid var(--border); border-radius: 5px; height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.4); position: relative; font-size: 0.6rem; font-weight: bold; cursor: pointer; text-align: center; }
        .slot-label { position: absolute; top: 1px; font-size: 0.45rem; color: #8b4513; text-transform: uppercase; font-weight: 900; }
        .slot-special { background: #e8daef; border-color: var(--special); color: #6c3483; }

        .controls { display: flex; align-items: center; justify-content: space-between; max-width: 1100px; margin: 8px auto 0; gap: 10px; }
        .backpack-container { flex: 1; display: flex; align-items: center; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 5px; overflow-x: auto; gap: 8px; min-height: 50px; }
        .bp-item { padding: 6px 10px; border-radius: 4px; font-size: 0.65rem; cursor: pointer; white-space: nowrap; font-weight: bold; border: 1px solid #999; background: #eee; }
        .bp-item.monster-hand { border: 2px dashed var(--munchkin); color: var(--munchkin); }
        .btn-action { background: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 5px; }
    </style>
</head>
<body>

<div id="setup-screen">
    <div class="setup-box">
        <h1 style="margin-top:0">MUNCHKIN</h1>
        <p>Selecione a quantidade de jogadores:</p>
        <div id="player-buttons">
            <button class="btn-action" onclick="iniciarJogo(3)">3</button>
            <button class="btn-action" onclick="iniciarJogo(4)">4</button>
            <button class="btn-action" onclick="iniciarJogo(5)">5</button>
            <button class="btn-action" onclick="iniciarJogo(6)">6</button>
        </div>
    </div>
</div>

<div id="leaderboard"></div>

<div id="table-center">
    <div id="phase-display" style="color:var(--gold); font-weight:bold; margin-bottom:10px">FASE: ABRIR PORTA</div>
    <div class="decks">
        <div id="deck-door" class="deck deck-door" onclick="faseAbrirPorta()">üö™<br>ABRIR PORTA</div>
        <div id="deck-loot" class="deck deck-loot" onclick="faseSaquearSala()" style="display:none;">üîé<br>SAQUEAR SALA</div>
    </div>
    <div id="log-container"></div>
</div>

<div id="battle-overlay">
    <div class="battle-card">
        <h2 id="m-name">Monstro</h2>
        <p>Poder do Grupo: <b id="p-power">0</b> vs Monstro: <b id="m-power">0</b></p>
        <div id="battle-btns">
            <button class="btn-action" onclick="tentarVencer()">LUTAR!</button>
            <button class="btn-action" style="background:var(--active)" onclick="abrirMenuAjuda()">PEDIR AJUDA</button>
            <button id="run-btn" class="btn-action" style="background:#e67e22; display:none;" onclick="fugir()">FUGIR (DADO)</button>
        </div>
        <div id="victory-claim" style="display:none">
            <button class="btn-action" style="background:var(--gold); color:black" onclick="recolherTesouros()">üíé RECOLHER TESOUROS</button>
        </div>
        <div id="help-menu" style="display:none; margin-top:15px; border-top:1px solid #ccc; padding-top:10px">
            <div id="helper-list"></div>
        </div>
    </div>
</div>

<div id="player-area">
    <div class="playmat" id="playmat-grid"></div>
    <div class="controls">
        <div id="gold-info" style="color:var(--gold); font-weight:bold; min-width:60px">üí∞ 0</div>
        <div id="backpack-list" class="backpack-container"></div>
        <button id="main-btn" class="btn-action" style="display:none">FINALIZAR TURNO</button>
    </div>
</div>

<script>
    let jogadores = [], vez = 0, visao = 0, faseAtual = 0, totalJogadores = 3;
    let monstroAtual = null, ajudante = null, combateOcorreu = false;

    const cards = {
        portas: [
            {n: "Planta de Vaso", lvl: 1, tes: 1, tipo: "monstro"},
            {n: "Drag√£o", lvl: 20, tes: 5, tipo: "monstro", bad: "MORTE"},
            {n: "Orc", lvl: 8, tes: 2, tipo: "monstro"},
            {n: "Elfo", tipo: "raca"}, {n: "An√£o", tipo: "raca"},
            {n: "Guerreiro", tipo: "classe"}, {n: "Mago", tipo: "classe"},
            {n: "Mesti√ßo", tipo: "special_raca"}, {n: "Super Munchkin", tipo: "special_classe"}
        ],
        tesouros: [
            {n: "Espada +3", b: 3, v: 400, tipo: "hand1"},
            {n: "Escudo +2", b: 2, v: 300, tipo: "hand1", reqRaca: "An√£o"},
            {n: "Motosserra +5", b: 5, v: 800, tipo: "hand2", big: true, reqClasse: "Guerreiro"},
            {n: "Armadura +2", b: 2, v: 500, tipo: "body"},
            {n: "Capacete +1", b: 1, v: 200, tipo: "head"}
        ]
    };

    function iniciarJogo(num) {
        totalJogadores = num;
        jogadores = [];
        for(let i=1; i<=num; i++) {
            jogadores.push({
                id: i, nome: "Jogador " + i, nivel: 1, ouro: 0, 
                racas: ["Humano"], classes: ["Nenhuma"],
                isMestico: false, isSuper: false,
                equips: { head: null, body: null, hand1: null, hand2: null }, mochila: []
            });
        }
        jogadores.forEach(j => {
            for(let i=0; i<4; i++) j.mochila.push({...cards.portas[Math.floor(Math.random()*cards.portas.length)]});
            for(let i=0; i<4; i++) j.mochila.push({...cards.tesouros[Math.floor(Math.random()*cards.tesouros.length)]});
        });
        document.getElementById('setup-screen').style.display = 'none';
        vez = Math.floor(Math.random() * num); visao = vez;
        adicionarLog(jogadores[vez].nome + " come√ßa!");
        atualizarUI();
    }

    function calcularPoder(p) {
        let total = p.nivel;
        for (let s in p.equips) if (p.equips[s]) total += p.equips[s].b;
        return total;
    }

    function renomearJogador(idx) {
        const n = prompt("Novo nome:", jogadores[idx].nome);
        if(n) { jogadores[idx].nome = n.substring(0,12); atualizarUI(); }
    }

    function gerenciarMochila(idx, e) {
        if(visao !== vez) return;
        const p = jogadores[vez];
        const item = p.mochila[idx];

        // Venda (Direito/Ctrl)
        if(faseAtual >= 1 && (e.button === 2 || e.ctrlKey)) {
            e.preventDefault();
            if(item.v && p.nivel < 9) {
                p.ouro += item.v;
                if(p.ouro >= 1000) { p.nivel++; p.ouro -= 1000; adicionarLog("Subiu de N√≠vel por venda!"); }
                p.mochila.splice(idx, 1);
                atualizarUI();
            }
            return;
        }

        // Procurar Encrenca
        if(faseAtual === 1 && !combateOcorreu && item.tipo === "monstro") {
            if(confirm("Deseja procurar encrenca com " + item.n + "?")) {
                monstroAtual = p.mochila.splice(idx, 1)[0];
                abrirCombate();
            }
            return;
        }

        // Super Munchkin / Mesti√ßo
        if(item.tipo === "special_raca") {
            if(p.racas[0] !== "Humano") { p.isMestico = true; p.mochila.splice(idx,1); }
            else alert("Precisa de uma Ra√ßa primeiro!");
        } else if(item.tipo === "special_classe") {
            if(p.classes[0] !== "Nenhuma") { p.isSuper = true; p.mochila.splice(idx,1); }
            else alert("Precisa de uma Classe primeiro!");
        }
        // Ra√ßas e Classes
        else if(item.tipo === "raca") {
            if(p.isMestico && p.racas.length < 2 && !p.racas.includes(item.n)) {
                if(p.racas[0] === "Humano") p.racas = [item.n]; else p.racas.push(item.n);
            } else { p.racas = [item.n]; }
            p.mochila.splice(idx, 1);
        } else if(item.tipo === "classe") {
            if(p.isSuper && p.classes.length < 2 && !p.classes.includes(item.n)) {
                if(p.classes[0] === "Nenhuma") p.classes = [item.n]; else p.classes.push(item.n);
            } else { p.classes = [item.n]; }
            p.mochila.splice(idx, 1);
        }
        // Equipar Itens
        else if(p.equips.hasOwnProperty(item.tipo)) {
            if(item.big && !p.racas.includes("An√£o") && Object.values(p.equips).some(it=>it?.big)) return alert("J√° tem item Grande!");
            if(!p.equips[item.tipo]) p.equips[item.tipo] = p.mochila.splice(idx, 1)[0];
        }
        atualizarUI();
    }

    function abrirCombate() {
        document.getElementById('battle-overlay').style.display = "flex";
        document.getElementById('battle-btns').style.display = "block";
        document.getElementById('victory-claim').style.display = "none";
        document.getElementById('run-btn').style.display = "none";
        document.getElementById('help-menu').style.display = "none";
        ajudante = null; atualizarLuta();
    }

    function abrirMenuAjuda() {
        const list = document.getElementById('helper-list'); list.innerHTML = "<b>Pedir ajuda para:</b><br>";
        jogadores.forEach((j, i) => {
            if(i !== vez) {
                // VISUALIZA√á√ÉO DO PODER NA AJUDA
                list.innerHTML += `<button class="btn-action" style="font-size:0.7rem" onclick="definirAjudante(${i})">
                    ${j.nome} (Poder: ${calcularPoder(j)})
                </button>`;
            }
        });
        document.getElementById('help-menu').style.display = "block";
    }

    function definirAjudante(idx) {
        ajudante = jogadores[idx];
        adicionarLog(ajudante.nome + " est√° ajudando!");
        document.getElementById('help-menu').style.display = "none";
        atualizarLuta();
    }

    function atualizarLuta() {
        let pTotal = calcularPoder(jogadores[vez]) + (ajudante ? calcularPoder(ajudante) : 0);
        document.getElementById('m-name').innerText = monstroAtual.n + " (N√≠vel " + monstroAtual.lvl + ")";
        document.getElementById('p-power').innerText = pTotal;
        document.getElementById('m-power').innerText = monstroAtual.lvl;
    }

    function tentarVencer() {
        let pTotal = calcularPoder(jogadores[vez]) + (ajudante ? calcularPoder(ajudante) : 0);
        if(pTotal > monstroAtual.lvl) {
            document.getElementById('battle-btns').style.display = "none";
            document.getElementById('victory-claim').style.display = "block";
            combateOcorreu = true;
        } else {
            alert("Poder insuficiente!");
            document.getElementById('run-btn').style.display = "inline-block";
        }
    }

    function recolherTesouros() {
        jogadores[vez].nivel++;
        if(jogadores[vez].nivel >= 10) { alert(jogadores[vez].nome + " VENCEU!"); location.reload(); }
        for(let i=0; i<monstroAtual.tes; i++) jogadores[vez].mochila.push({...cards.tesouros[Math.floor(Math.random()*cards.tesouros.length)]});
        document.getElementById('battle-overlay').style.display = "none";
        faseAtual = 2; atualizarUI();
    }

    function fugir() {
        const dado = Math.floor(Math.random()*6)+1;
        if(dado >= 5) { alert("Fugiu! (Dado: "+dado+")"); }
        else { alert("Mau Caminho! (Dado: "+dado+")"); jogadores[vez].nivel = Math.max(1, jogadores[vez].nivel - 1); }
        document.getElementById('battle-overlay').style.display = "none";
        faseAtual = 2; atualizarUI();
    }

    function faseAbrirPorta() {
        const c = cards.portas[Math.floor(Math.random()*cards.portas.length)];
        adicionarLog("Abriu Porta: " + c.n);
        if(c.tipo === "monstro") { monstroAtual = c; abrirCombate(); }
        else { jogadores[vez].mochila.push(c); faseAtual = 1; }
        atualizarUI();
    }

    function faseSaquearSala() { 
        jogadores[vez].mochila.push({...cards.portas[Math.floor(Math.random()*cards.portas.length)]}); 
        adicionarLog("Saqueou a sala.");
        faseAtual = 2; atualizarUI(); 
    }

    function finalizarTurno() {
        if(jogadores[vez].mochila.length > 5) { alert("CARIDADE: Reduza sua m√£o para 5 cartas!"); return; }
        vez = (vez + 1) % totalJogadores; visao = vez; faseAtual = 0; combateOcorreu = false; atualizarUI();
    }

    function atualizarUI() {
        const pV = jogadores[visao];
        const lb = document.getElementById('leaderboard'); lb.innerHTML = "";
        jogadores.forEach((j, i) => {
            lb.innerHTML += `
                <div class="player-status-card ${i===vez?'active-turn':''}" onclick="visao=${i}; atualizarUI()">
                    <span class="p-name" onclick="event.stopPropagation(); renomearJogador(${i})">${j.nome} ‚úèÔ∏è</span>
                    <span class="p-stats">Lvl ${j.nivel} | Poder ${calcularPoder(j)}</span>
                </div>`;
        });

        document.getElementById('playmat-grid').innerHTML = `
            <div class="slot" onclick="desequipar('raca')"><span class="slot-label">Ra√ßa</span>${pV.racas.join('/')}</div>
            <div class="slot" onclick="desequipar('classe')"><span class="slot-label">Classe</span>${pV.classes.join('/')}</div>
            <div class="slot ${pV.isMestico?'slot-special':''}" onclick="desequipar('mestico')"><span class="slot-label">Mesti√ßo</span>${pV.isMestico?'SIM':'-'}</div>
            <div class="slot ${pV.isSuper?'slot-special':''}" onclick="desequipar('super')"><span class="slot-label">Super</span>${pV.isSuper?'SIM':'-'}</div>
            <div class="slot" style="background:#fff; border-color:var(--munchkin)"><span class="slot-label">PODER</span>${calcularPoder(pV)}</div>
            <div class="slot" onclick="desequipar('head')"><span class="slot-label">Cabe√ßa</span>${pV.equips.head?.n || '-'}</div>
            <div class="slot" onclick="desequipar('body')"><span class="slot-label">Corpo</span>${pV.equips.body?.n || '-'}</div>
            <div class="slot" onclick="desequipar('hand1')"><span class="slot-label">M√£o 1</span>${pV.equips.hand1?.n || '-'}</div>
            <div class="slot" onclick="desequipar('hand2')"><span class="slot-label">M√£o 2</span>${pV.equips.hand2?.n || '-'}</div>
            <div class="slot" style="background:#eee"><span class="slot-label">N√çVEL</span>${pV.nivel}</div>
        `;

        const bl = document.getElementById('backpack-list'); bl.innerHTML = "";
        pV.mochila.forEach((it, idx) => {
            bl.innerHTML += `<div class="bp-item ${it.tipo==='monstro'?'monster-hand':''}" onmousedown="gerenciarMochila(${idx}, event)">${it.n}</div>`;
        });

        document.getElementById('gold-info').innerText = `üí∞ ${pV.ouro}`;
        document.getElementById('deck-door').style.display = (faseAtual === 0 && visao === vez) ? "flex" : "none";
        document.getElementById('deck-loot').style.display = (faseAtual === 1 && !combateOcorreu && visao === vez) ? "flex" : "none";
        
        const btn = document.getElementById('main-btn');
        if(visao !== vez) btn.style.display = "none";
        else {
            btn.style.display = (faseAtual === 2) ? "block" : "none";
            btn.onclick = finalizarTurno;
        }
        document.getElementById('phase-display').innerText = `FASE: ${["ABRIR PORTA", "ENCRENCA/SAQUEAR", "CARIDADE"][faseAtual]}`;
    }

    function desequipar(slot) {
        if(visao !== vez) return;
        const p = jogadores[vez];
        if(slot === 'raca') { p.mochila.push({n:p.racas.pop(), tipo:'raca'}); if(p.racas.length===0) p.racas=["Humano"]; p.isMestico = false; }
        else if(slot === 'classe') { p.mochila.push({n:p.classes.pop(), tipo:'classe'}); if(p.classes.length===0) p.classes=["Nenhuma"]; p.isSuper = false; }
        else if(slot === 'mestico') { p.isMestico = false; p.mochila.push({n:"Mesti√ßo", tipo:"special_raca"}); }
        else if(slot === 'super') { p.isSuper = false; p.mochila.push({n:"Super Munchkin", tipo:"special_classe"}); }
        else if(p.equips[slot]) { p.mochila.push(p.equips[slot]); p.equips[slot] = null; }
        atualizarUI();
    }

    function adicionarLog(m) { document.getElementById('log-container').innerHTML = `<div>> ${m}</div>` + document.getElementById('log-container').innerHTML; }
    window.oncontextmenu = (e) => { if(e.target.classList.contains('bp-item')) return false; };
</script>
</body>
</html>